<html>
<head>
	<script src="ptv-hmac-sha1.js"></script>
	<script type="text/javascript">
		var PTV = {
			//Fields
			//NOTE: Use of the developer ID and secret key contained in this site 
			//is subject to the Terms of Use of the PTV API. Unauthorised use of 
			//these credentials is prohibited. You can request your own key from 
			//PTV via email.
			
			//Methods
			generateSignature: function(request) {
				var hash = CryptoJS.HmacSHA1(request, this._secret);
				return hash;
			},
			
			//Creates and sends an AJAX request to the specified endpoint. Internally, this
			//handles the API authentication and signing.
			//Upon success, the specified callback function is invoked, with the response
			//data passed as a parameter.
			sendRequestInner: function(endpoint, callBackFunc, params) {
				var settings = this.getGlobalSettings();
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange=function() {
  					if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
  						callBackFunc(endpoint, JSON.parse(xmlhttp.responseText), params);
  					}
  				}

  				var qs = endpoint.indexOf("?") == -1 ? "?" : "&";
  				endpoint = endpoint.indexOf("devId=") == -1 ? endpoint + qs + "devid=" + this._devId : endpoint;
  				var sig = this.generateSignature(endpoint);
  				var url = settings.baseUrl + endpoint + "&signature=" + sig;
  				
  				if (settings.useCorsBypass == true) {
  					url = 'https://cors-anywhere.herokuapp.com/' + url;
  				}

				xmlhttp.open("GET", url, true);
				xmlhttp.send();
			},
			
			/*
			
			send departures request and return data as promise
			send stops on route request and return data as promise
			send stopping pattern request and return data as promise
			display departures and return promise
			display stopping pattern
			
			*/
			
			sendRequest: function(endpoint, name, state) {				
				return new Promise(function(resolve, reject) {
					document.getElementById('loading').innerHTML += name + '...';
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function() {					
						if (xmlhttp.readyState === XMLHttpRequest.DONE) {
							if (xmlhttp.status === 200) {
								document.getElementById('loading').innerHTML += 'done. ';
								state.data = JSON.parse(xmlhttp.responseText);
								resolve(state);
							} else {
								reject('Something went wrong.');
							}
						}
					};
					
					var settings = PTV.getGlobalSettings();
				
					var qs = endpoint.indexOf("?") == -1 ? "?" : "&";
					endpoint = endpoint.indexOf("devId=") == -1 ? endpoint + qs + "devid=" + PTV._devId : endpoint;
					var sig = PTV.generateSignature(endpoint);
					var url = settings.baseUrl + endpoint + "&signature=" + sig;
				
					if (settings.useCorsBypass == true) {
						url = 'https://cors-anywhere.herokuapp.com/' + url;
					}

					xmlhttp.open("GET", url, true);
					xmlhttp.send();
				});
			},
			
			doStuff: function(params) {			
				Promise.resolve(params)
					.then(this.requestDepartures)
					.then(this.requestStopsOnRoute)
					.then(this.requestStoppingPattern)
					.then(this.updatePage)
					.catch(function(e) {
						document.getElementById('error').innerHTML = 'Error: ' + e;
					})
			},
			
			requestDepartures: function(params) {
				return new Promise(function(resolve, reject) {
					var endpoint = PTV.buildDeparturesEndpoint(params);
					resolve(PTV.sendRequest(endpoint, 'Departures', { data: null, params: params }));
				});
			},
			
			requestStopsOnRoute: function(state) {								
				return new Promise(function(resolve, reject) {
					state.departures = state.data;
					state.data = null;
				
					if (state.departures == null || state.departures.departures.length == 0) {
						reject('No departures found.');
					}
				
					state.params.route_id = state.departures.departures[0].route_id; //TODO handle empty departures
					state.params.run_id = state.departures.departures[0].run_id; //TODO handle empty departures
				
					var endpoint = PTV.buildStopsOnRouteEndpoint(state.params);
				
					resolve(PTV.sendRequest(endpoint, 'Stops on route', state));
				});
			},
			
			requestStoppingPattern: function(state) {
				return new Promise(function(resolve, reject) {
					state.stopsOnRoute = state.data;
					state.data = null;
				
					var endpoint = PTV.buildStoppingPatternEndpoint(state.params);
				
					resolve(PTV.sendRequest(endpoint, 'Stopping pattern', state));
				});
			},
			
			updatePage: function(state) {
				return new Promise(function(resolve, reject) {
					document.getElementById('loading').style.visibility = 'hidden';		
					state.pattern = state.data;
					state.data = null;
					var next_departure = state.departures.departures[0];
				
					//Reset some elements
					document.getElementById('error').innerHTML = '';
				
					//Set stop name
					var stop_name = '';
					var selected_stop_index = 0;
					for (var i = 0; i < state.stopsOnRoute.stops.length; i++) {
						if (state.stopsOnRoute.stops[i].stop_id == state.params.stop_id) {
							stop_name = state.stopsOnRoute.stops[i].stop_name;
							selected_stop_index = i;
							break;
						}
					}
					document.getElementById('stop').innerHTML = stop_name;
				
					//Set platform number
					document.getElementById('platform').innerHTML = 'Platform ' + next_departure.platform_number;
				
					//Set next departure
					var next_departure_name = state.departures.runs[next_departure.run_id].destination_name;				
					document.getElementById('next-dest').innerHTML = next_departure_name;
				
					var time = formatSingleTime(next_departure.scheduled_departure_utc);				
					document.getElementById('next-time').innerHTML = time;
				
					var diff = getDifferenceFromNow(next_departure.estimated_departure_utc, next_departure.scheduled_departure_utc);
					document.getElementById('next-diff').innerHTML = diff + 'mins';
				
					//Set stopping pattern
				
					//Set following departures
					clearFollowingDepartures();
					for (var i = 1; i < state.departures.departures.length; i++) {
						addFollowingDeparture(state, i);
					}
				
					//TODO update view and return something
					//return sendRequest(endpoint, state);
				});
			},
			
			/* Util functions */
			
			getIsoDate: function() {
				return new Date().toISOString();
			},
			
			getGlobalSettings: function() {
				return {
					baseUrl: 'http://timetableapi.ptv.vic.gov.au',
					useCorsBypass: true
				}
			},
			
			/* Request functions */
			
			//Departures
			/*makeDeparturesRequest: function(params) {
				var endpoint = this.buildDeparturesEndpoint(params);				
				this.sendRequestInner(endpoint, this.printDeparturesOutput, params);
			},
			*/
			buildDeparturesEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/departures/route_type/{route_type}/stop/{stop_id}' +
						'?max_results=4&date_utc={date_utc}&platform_numbers={platform_number}&expand=stop&expand=run';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{stop_id}', params.stop_id)
									.replace('{platform_number}', params.platform_number)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			},
			
			/*printDeparturesOutput: function(endpoint, data, params) {
				if (data.departures.length == 0) {
					return;
				}
			
				//var time = formatTime(data.departures[0].estimated_departure_utc, data.departures[0].scheduled_departure_utc); 
				
				var time = formatSingleTime(data.departures[0].scheduled_departure_utc);
				var diff = getDifferenceFromNow(data.departures[0].estimated_departure_utc, data.departures[0].scheduled_departure_utc); 
				var stop_name = data.stops[params.stop_id].stop_name;
				document.getElementById('stop').innerHTML = stop_name;
				document.getElementById('platform').innerHTML = 'Platform ' + data.departures[0].platform_number;
				document.getElementById('next-dest').innerHTML = data.runs[data.departures[0].run_id].destination_name;
				document.getElementById('next-time').innerHTML = time;
				document.getElementById('next-diff').innerHTML = diff + 'mins';
				
				clearFollowingDepartures();
				for (var i = 1; i < data.departures.length; i++) {
					addFollowingDeparture(data, i);
				}
				
				//Display stopping pattern
				var run_id = data.departures[0].run_id;
				
				var stopping_pattern_params = {
					route_type: params.route_type,
					stop_id: params.stop_id,
					run_id: run_id
				};
			
				PTV.makeStoppingPatternRequest(stopping_pattern_params);
			},*/
			
			//Stops on route
			buildStopsOnRouteEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/stops/route/{route_id}/route_type/{route_type}' +
						'?date_utc={date_utc}';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{route_id}', params.route_id)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			},
			
			//Stopping pattern
			/*makeStoppingPatternRequest: function(params) {
				var endpoint = this.buildStoppingPatternEndpoint(params);				
				this.sendRequestInner(endpoint, this.printStoppingPatternOutput, params);
			},*/
			
			buildStoppingPatternEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/pattern/run/{run_id}/route_type/{route_type}' +
						'?date_utc={date_utc}';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{run_id}', params.run_id)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			},
			
			/*printStoppingPatternOutput: function(endpoint, data, params) {
				if (data.departures.length == 0) {
					document.getElementById('next-stops').innerHTML = 'Could not load stopping pattern.';
					return;
				}
				
				clearStoppingPattern();
				for (var i = 1; i < data.departures.length; i++) {
					addStoppingPatternItem(data, i);
				}
			}*/
			
		};
		
		function addFollowingDeparture(state, index) {
			//var time = formatTime(data.departures[index].estimated_departure_utc, data.departures[index].scheduled_departure_utc); 
			
			var time = formatSingleTime(state.departures.departures[index].scheduled_departure_utc);
			var diff = getDifferenceFromNow(state.departures.departures[index].estimated_departure_utc, state.departures.departures[index].scheduled_departure_utc); 
			var dest = state.departures.runs[state.departures.departures[index].run_id].destination_name;
		
			var wrapper = document.createElement('div');
			wrapper.innerHTML = time + '&nbsp;&nbsp;&nbsp;' + dest + '&nbsp;&nbsp;&nbsp;' + diff + 'mins';
			document.getElementById('following-departures').appendChild(wrapper);
		}
		
		function clearFollowingDepartures() {
			document.getElementById('following-departures').innerHTML = '';
		}
		
		/*function addStoppingPatternItem(data, index) {
			var wrapper = document.createElement('div');
			wrapper.innerHTML = data.departures[index].stop_id;
			document.getElementById('next-stops').appendChild(wrapper);
		}*/
		
		/*function clearStoppingPattern() {
			document.getElementById('next-stops').innerHTML = '';
		}*/
		
		function formatTime(estimated, scheduled) {
			var date = estimated == null
				? new Date(scheduled)
				: new Date(estimated);
			
			var hrs = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
			var mins = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
			var result = hrs + ":" + mins;
			return result;
		}
		
		function formatSingleTime(time) {
			var date = new Date(time);
			
			var hrs = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
			var mins = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
			var result = hrs + ":" + mins;
			return result;
		}
		
		function getDifferenceFromNow(estimated, scheduled) {
			var date = estimated == null
				? new Date(scheduled)
				: new Date(estimated);
			
			var now = new Date();
			
			return Math.ceil(((date.getTime() - now.getTime()) / 1000) / 60);
		}
		
		function init() {
			PTV._devId = getQueryVariable('d');
			PTV._secret = getQueryVariable('s');
			var platform_number = getQueryVariable('p');
			var e = document.getElementById("platform-select");
			e.value = platform_number;
			
			if (PTV._devId == null || PTV._devId == '' || PTV._secret == null || PTV._secret == '') {
				return;
			}
			
			updateView();
		}
		
		function updateView() {
			var loading = document.getElementById('loading');
			loading.style.visibility = 'visible';
			loading.innerHTML = 'Loading: ';
			var stop_id = getQueryVariable('stop_id');
			var route_type = getQueryVariable('route_type');
			var e = document.getElementById("platform-select");
			var platform_number = e.options[e.selectedIndex].value;
			
			var new_url = window.location.pathname + updateQueryVariable('p', platform_number);
			window.history.replaceState( {} , 'Platform View', new_url );
			
			var params = {
				route_type: route_type,
				stop_id: stop_id,
				platform_number: platform_number
			};
			
			PTV.doStuff(params);
		}
		
		//https://css-tricks.com/snippets/javascript/get-url-variables/
		function getQueryVariable(variable) {
		   var query = window.location.search.substring(1);
		   var vars = query.split("&");
		   for (var i=0;i<vars.length;i++) {
			   var pair = vars[i].split("=");
			   if(pair[0] == variable){return pair[1];}
		   }
		   return(false);
		}
		
		function updateQueryVariable(key, value) {
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			var result = "";
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == key){
					result = result + "&" + pair[0] + "=" + value;
				} else {
					result = result + "&" + pair[0] + "=" + pair[1];
				}
			}
			return "?" + result.substring(1);
		}
	</script>
	<style>
		body {
			font-family: arial;
			background-color: #222;
			color: #FFF;
			font-size: 20px;
		}
		select {
			font-size: 20px;
			width: 100px;
		}
		#next-stops {
			font-size: 16px;
		}
		#error { color: #f55; }
		#loading { font-size: 12px; }
	</style>
</head>
<body onload="init()">
	<div id="loading">Loading: </div>
	<span id="stop"></span> - <span id="platform"></span>&nbsp;
	<span id="platform-select-wrapper">
		<select id="platform-select" onchange="updateView()">
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
			<option value="13">13</option>
			<option value="14">14</option>
		</select>
	</span>
	<br />
	<div>Next departure:</div>
	<span id="next-time"></span>&nbsp;&nbsp;&nbsp;	
	<span id="next-dest"></span>&nbsp;&nbsp;&nbsp;
	<span id="next-diff"></span>&nbsp;&nbsp;&nbsp;
	<div id="next-stops"></div>
	<br />
	<div>Following departure(s):</div>
	<div id="following-departures"></div>
	<div id="error"></div>
</body>
</html>