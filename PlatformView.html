<html>
<head>
	<script src="ptv-hmac-sha1.js"></script>
	<script type="text/javascript">
		var PTV = {
			//Fields
			//NOTE: Use of the developer ID and secret key contained in this site 
			//is subject to the Terms of Use of the PTV API. Unauthorised use of 
			//these credentials is prohibited. You can request your own key from 
			//PTV via email.
			
			//Methods
			generateSignature: function(request) {
				var hash = CryptoJS.HmacSHA1(request, this._secret);
				return hash;
			},
			
			//Creates and sends an AJAX request to the specified endpoint. Internally, this
			//handles the API authentication and signing.
			//Upon success, the specified callback function is invoked, with the response
			//data passed as a parameter.
			sendRequestInner: function(endpoint, callBackFunc, params) {
				var settings = this.getGlobalSettings();
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange=function() {
  					if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
  						callBackFunc(endpoint, JSON.parse(xmlhttp.responseText), params);
  					}
  				}

  				var qs = endpoint.indexOf("?") == -1 ? "?" : "&";
  				endpoint = endpoint.indexOf("devId=") == -1 ? endpoint + qs + "devid=" + this._devId : endpoint;
  				var sig = this.generateSignature(endpoint);
  				var url = settings.baseUrl + endpoint + "&signature=" + sig;
  				
  				if (settings.useCorsBypass == true) {
  					//url = 'https://cors-anywhere.herokuapp.com/' + url;
  					url = 'http://ptvproxy20170416075948.azurewebsites.net/api/proxy?url=' + encodeURIComponent(url);
  				}

				xmlhttp.open("GET", url, true);
				xmlhttp.send();
			},
			
			sendRequest: function(endpoint, name, state) {				
				return new Promise(function(resolve, reject) {
					document.getElementById('loading').innerHTML += '.';
					//document.getElementById('loading').innerHTML += name + '...';
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function() {					
						if (xmlhttp.readyState === XMLHttpRequest.DONE) {
							if (xmlhttp.status === 200) {
								//document.getElementById('loading').innerHTML += 'done. ';
								state.data = JSON.parse(xmlhttp.responseText);
								resolve(state);
							} else {
								reject('Something went wrong.');
							}
						}
					};
					
					var settings = PTV.getGlobalSettings();
				
					var qs = endpoint.indexOf("?") == -1 ? "?" : "&";
					endpoint = endpoint.indexOf("devId=") == -1 ? endpoint + qs + "devid=" + PTV._devId : endpoint;
					var sig = PTV.generateSignature(endpoint);
					var url = settings.baseUrl + endpoint + "&signature=" + sig;
				
					if (settings.useCorsBypass == true) {
						//url = 'https://cors-anywhere.herokuapp.com/' + url;
						url = 'http://ptvproxy20170416075948.azurewebsites.net/api/proxy?url=' + encodeURIComponent(url);
					}

					xmlhttp.open("GET", url, true);
					xmlhttp.send();
				});
			},
			
			doStuff: function(params) {			
				Promise.resolve(params)
					.then(this.requestDepartures)
					.then(this.requestStopsOnRoute)
					.then(this.requestStoppingPattern)
					.then(this.updatePage)
					.catch(function(e) {
						document.getElementById('error').innerHTML = 'Error: ' + e;
						this.clearPage();					
					})
			},
			
			requestDepartures: function(params) {
				return new Promise(function(resolve, reject) {
					var endpoint = PTV.buildDeparturesEndpoint(params);
					resolve(PTV.sendRequest(endpoint, 'Departures', { data: null, params: params }));
				});
			},
			
			requestStopsOnRoute: function(state) {								
				return new Promise(function(resolve, reject) {
					state.departures = state.data;
					state.data = null;
				
					if (state.departures == null || state.departures.departures.length == 0) {
						reject('No departures found.');
					}
				
					state.params.route_id = state.departures.departures[0].route_id;
					state.params.run_id = state.departures.departures[0].run_id;
				
					var endpoint = PTV.buildStopsOnRouteEndpoint(state.params);
				
					resolve(PTV.sendRequest(endpoint, 'Stops on route', state));
				});
			},
			
			requestStoppingPattern: function(state) {
				return new Promise(function(resolve, reject) {
					state.stopsOnRoute = state.data;
					state.data = null;
				
					var endpoint = PTV.buildStoppingPatternEndpoint(state.params);
				
					resolve(PTV.sendRequest(endpoint, 'Stopping pattern', state));
				});
			},
			
			clearPage: function() {
				document.getElementById('platform').innerHTML = '';
				document.getElementById('next-dest').innerHTML = '';
				document.getElementById('next-time').innerHTML = '';
				document.getElementById('next-diff').innerHTML = '';
				clearStoppingPattern();
				clearFollowingDepartures();
			},
			
			updatePage: function(state) {
				return new Promise(function(resolve, reject) {
								
					//Update the loading indicator and display the current time
					document.getElementById('loading').innerHTML += 'done.';					
					var refresh_date = new Date();
					document.getElementById('refresh-time').innerHTML = refresh_date.getHours() + 
						':' + refresh_date.getMinutes() + ':' + refresh_date.getSeconds();					
					
					state.pattern = state.data;
					state.data = null;
					var next_departure = state.departures.departures[0];
				
					//Reset some elements
					document.getElementById('error').innerHTML = '';
				
					//Set stop name
					var stop_name = '';
					var selected_stop_index = 0;
					for (var i = 0; i < state.stopsOnRoute.stops.length; i++) {
						if (state.stopsOnRoute.stops[i].stop_id == state.params.stop_id) {
							stop_name = state.stopsOnRoute.stops[i].stop_name;
							selected_stop_index = i;
							break;
						}
					}
					document.getElementById('stop').innerHTML = stop_name.replace(' Station', '');
				
					//Set platform number
					document.getElementById('platform').innerHTML = 'Platform ' + next_departure.platform_number;
				
					//Set next departure
					var next_departure_name = state.departures.runs[next_departure.run_id].destination_name;				
					document.getElementById('next-dest').innerHTML = next_departure_name;
				
					var time = formatSingleTime(next_departure.scheduled_departure_utc);				
					document.getElementById('next-time').innerHTML = time;
				
					var diff = getDifferenceFromNow(next_departure.estimated_departure_utc, next_departure.scheduled_departure_utc);
					document.getElementById('next-diff').innerHTML = diff + 'mins';
				
					//Set stopping pattern
					clearStoppingPattern();
					var stops = new Map();
					for (var s = 0; s < state.stopsOnRoute.stops.length; s++) {
						stops.set(state.stopsOnRoute.stops[s].stop_id, state.stopsOnRoute.stops[s].stop_name);
					}
					
					var found_current_stop = false;
					var stopping_pattern_count = 0;
					for (var j = 0; j < state.pattern.departures.length; j++) {
						var stop_id = state.pattern.departures[j].stop_id;
												
						if (found_current_stop) {							
							var name = stops.get(stop_id).replace(' Station', '');
							addStoppingPatternItem(name);
						}
						
						if (stop_id == state.params.stop_id) {
							stopping_pattern_count = state.pattern.departures.length - j;
							found_current_stop = true;
						}
					}				
					
					var list_element = document.getElementById('next-stops-list');
					if (stopping_pattern_count > 7) {
						if (list_element.className.indexOf('two-columns') == -1) {
							list_element.className += 'two-columns';
						}
					} else {
						list_element.className = list_element.className.replace('two-columns', '');
					}
					
					//Set following departures
					clearFollowingDepartures();
					for (var i = 1; i < state.departures.departures.length; i++) {
						addFollowingDeparture(state, i);
					}
					resolve();
				});
			},
			
			
			/* Util functions */
						
			getIsoDate: function() {
				return new Date().toISOString();
			},
			
			getGlobalSettings: function() {
				return {
					baseUrl: 'http://timetableapi.ptv.vic.gov.au',
					useCorsBypass: true
				}
			},
			
			/* Request functions */
			
			//Departures
			buildDeparturesEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/departures/route_type/{route_type}/stop/{stop_id}' +
						'?max_results=6&date_utc={date_utc}&platform_numbers={platform_number}&expand=stop&expand=run';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{stop_id}', params.stop_id)
									.replace('{platform_number}', params.platform_number)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			},
			
			//Stops on route
			buildStopsOnRouteEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/stops/route/{route_id}/route_type/{route_type}' +
						'?date_utc={date_utc}';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{route_id}', params.route_id)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			},

			//Stopping pattern
			buildStoppingPatternEndpoint: function(params) {
				var date_utc = PTV.getIsoDate();
				var template = '/v3/pattern/run/{run_id}/route_type/{route_type}' +
						'?date_utc={date_utc}';
				var endpoint = template
									.replace('{route_type}', params.route_type)
									.replace('{run_id}', params.run_id)					
									.replace('{date_utc}', date_utc);
				return endpoint;
			}			
		};
		
		function addFollowingDeparture(state, index) {
			var time = formatSingleTime(state.departures.departures[index].scheduled_departure_utc);
			var diff = getDifferenceFromNow(state.departures.departures[index].estimated_departure_utc, state.departures.departures[index].scheduled_departure_utc); 
			var dest = state.departures.runs[state.departures.departures[index].run_id].destination_name;
			var status = state.departures.runs[state.departures.departures[index].run_id].status;
			var disruptions = state.departures.runs[state.departures.departures[index].run_id].disruption_ids;
			var disruption_marker = disruptions != undefined && disruptions.length > 0 ? '!&nbsp;' : '';
			
			if (diff >= 60) {
				return;
			}
		
			var wrapper = document.createElement('div');
			wrapper.innerHTML = disruption_marker + time + '&nbsp;&nbsp;&nbsp;' + dest + '&nbsp;&nbsp;&nbsp;' + diff + 'mins&nbsp;&nbsp;&nbsp;(' + status + ')';
			document.getElementById('following-departures').appendChild(wrapper);
		}
		
		function clearFollowingDepartures() {
			document.getElementById('following-departures').innerHTML = '';
		}
		
		function addStoppingPatternItem(name, index) {
			var wrapper = document.createElement('li');
			wrapper.innerHTML = name;
			document.getElementById('next-stops-list').appendChild(wrapper);
		}
		
		function clearStoppingPattern() {
			document.getElementById('next-stops-list').innerHTML = '';
		}
		
		function formatTime(estimated, scheduled) {
			var date = estimated == null
				? new Date(scheduled)
				: new Date(estimated);
			
			var hrs = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
			var mins = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
			var result = hrs + ":" + mins;
			return result;
		}
		
		function formatSingleTime(time) {
			var date = new Date(time);
			
			var hrs = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
			var mins = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
			var result = hrs + ":" + mins;
			return result;
		}
		
		function getDifferenceFromNow(estimated, scheduled) {
			var date = estimated == null
				? new Date(scheduled)
				: new Date(estimated);
			
			var now = new Date();
			
			return Math.ceil(((date.getTime() - now.getTime()) / 1000) / 60);
		}
		
		function init() {
			PTV._devId = getQueryVariable('d');
			PTV._secret = getQueryVariable('s');
			var platform_number = getQueryVariable('p');
			var e = document.getElementById("platform-select");
			e.value = platform_number;
			
			if (PTV._devId == null || PTV._devId == '' || PTV._secret == null || PTV._secret == '') {
				return;
			}
			
			updateView();
		}
		
		function updateView() {
			var loading = document.getElementById('loading');
			loading.innerHTML = 'Loading';
			document.getElementById('refresh-time').innerHTML = '';
			
			var stop_id = getQueryVariable('stop_id');
			var route_type = getQueryVariable('route_type');
			var e = document.getElementById("platform-select");
			var platform_number = e.options[e.selectedIndex].value;
			
			var new_url = window.location.pathname + updateQueryVariable('p', platform_number);
			window.history.replaceState( {} , 'Platform View', new_url );
			
			//Set an auto-refresh timer
			updateTimer();
			
			var params = {
				route_type: route_type,
				stop_id: stop_id,
				platform_number: platform_number
			};
			
			PTV.doStuff(params);
		}
		
		var timer;
		function updateTimer() {			
			clearTimeout(timer);
			if (document.getElementById('auto-refresh').checked) {
				timer = setTimeout(function(){updateView()}, 30000);
			}
		}
		
		//https://css-tricks.com/snippets/javascript/get-url-variables/
		function getQueryVariable(variable) {
		   var query = window.location.search.substring(1);
		   var vars = query.split("&");
		   for (var i=0;i<vars.length;i++) {
			   var pair = vars[i].split("=");
			   if(pair[0] == variable){return pair[1];}
		   }
		   return(false);
		}
		
		function updateQueryVariable(key, value) {
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			var result = "";
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == key){
					result = result + "&" + pair[0] + "=" + value;
				} else {
					result = result + "&" + pair[0] + "=" + pair[1];
				}
			}
			return "?" + result.substring(1);
		}
	</script>
	<style>
		body {
			font-family: arial;
			background-color: #222;
			color: #FFF;
			font-size: 20px;
			min-width: 325px;
		}
		select {
			font-size: 20px;
			width: 100px;
		}
		#wrapper { max-width: 700px; }
		#next-stops {
			font-size: 16px;
		}
		#next-stops div {
			margin-top: 5px;
		}
		#error { color: #f55; }
		#loading, #refresh-time, #auto-refresh-label { 
			font-size: 18px; 
			margin-bottom: 5px; 
			display: inline-block;
			width: 25%;
		}
		#next-stops-list {
			list-style-type: none;
			padding-left: 0px;
		}
		.two-columns {
			-moz-column-count: 2;
			-moz-column-gap: 20px;
			-webkit-column-count: 2;
			-webkit-column-gap: 20px;
			column-count: 2;
			column-width: 20%;
			list-style-type: none;
			padding-left: 0px;
		}
		#next-stops-list li {
			margin-top: 5px;
		}
		#following-departures { margin-top: 20px; }
	</style>
</head>
<body onload="init()">
	<div>
		<span id="loading"></span>&nbsp;&nbsp;<span id="refresh-time"></span>		
		<input type="checkbox" id="auto-refresh" name="auto-refresh" checked="checked" onchange="updateTimer()" />
		<label id="auto-refresh-label" for="auto-refresh">Auto refresh</label>
	</div>
	<br />
	<div id="wrapper">
		<span id="stop"></span> - <span id="platform"></span>&nbsp;		
		<span id="platform-select-wrapper">
			<select id="platform-select" onchange="updateView()">
				<option value="1">1</option>
				<option value="2">2</option>
				<option value="3">3</option>
				<option value="4">4</option>
				<option value="5">5</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
				<option value="9">9</option>
				<option value="10">10</option>
				<option value="11">11</option>
				<option value="12">12</option>
				<option value="13">13</option>
				<option value="14">14</option>
			</select>
		</span>
		<br /><br />
		<span id="next-time"></span>&nbsp;&nbsp;&nbsp;	
		<span id="next-dest"></span>&nbsp;&nbsp;&nbsp;
		<span id="next-diff"></span>&nbsp;&nbsp;&nbsp;
		<br />
		<div id="next-stops">
			<ul id="next-stops-list"></ul>
		</div>
		<div id="following-departures"></div>
		<div id="error"></div>
	</div>
</body>
</html>